# Signal Assistant Enclave Privacy Architecture Document

This document defines the privacy architecture of the Signal Assistant Enclave. It specifically focuses on the privacy guarantees and mechanisms within the Trusted Execution Environment (enclave), the untrusted host environment, and their interactions with external providers. This document serves as the definitive source of truth regarding how user data is handled, protected, and managed within this architectural context. It builds upon and extends the normative requirements and definitions provided in the [Signal Assistant Core Specification](signal_assistant_core.md), focusing specifically on privacy implications.

## 1. Executive Summary

This document details the privacy architecture of the Signal Assistant Enclave, a system designed to provide AI-powered assistance within the Signal messaging platform with an unwavering commitment to user privacy. Leveraging Trusted Execution Environments (TEEs), the architecture ensures that sensitive user data and conversational content are processed exclusively within a secure, verifiable enclave, shielded from the untrusted host environment. Key principles include data minimization, privacy by design, user control, and transparency, with strict policies governing data handling, retention, and access, particularly concerning interactions with external Large Language Models (LLMs) and law enforcement. The goal is to provide a comprehensive, human-understandable source of truth for all stakeholders regarding the privacy guarantees of the Signal Assistant.

**Key Takeaways:**
*   **Enclave-Centric Privacy:** All sensitive data and logic reside within a Trusted Execution Environment (TEE), minimizing exposure to the untrusted host.
*   **Data Minimization:** Only strictly necessary data is collected and processed, with ephemeral handling of plaintext conversation content.
*   **Strong Identity Protection:** Signal IDs are never directly linked to internal user activity outside the enclave; all internal processing uses opaque, anonymized `internal_user_id`s.
*   **No Persistent Plaintext Storage:** User messages and LLM responses are never stored persistently in plaintext.
*   **Limited Law Enforcement Access:** The architecture fundamentally prevents retrospective access to plaintext conversation content, with transparent policies for limited metadata access.

## 2. Introduction & Scope

### 2.1 Project Overview
The Signal Assistant is an AI-powered conversational agent integrated with the Signal messaging service. Its primary function is to enhance user experience by providing intelligent assistance, information retrieval, and potentially simple task automation, all while adhering to the highest standards of privacy and security. The core innovation lies in its enclave-centered architecture, which places all sensitive data processing and AI logic within a hardware-backed Trusted Execution Environment.

### 2.3 Definition of Terms
*   **Enclave:** A Trusted Execution Environment (TEE), a secure area within a processor that protects code and data confidentiality and integrity from the rest of the system, including the host OS and hypervisor.
*   **PII (Personally Identifiable Information):** Any data that could potentially identify a specific individual.
*   **Host:** The untrusted operating system and hardware environment outside the enclave. It provides resources to the enclave but cannot access or tamper with the enclave's sensitive data or code.
*   **User Data:** Any information generated by or associated with a user, including messages, metadata, and identity information.
*   **Internal User ID (`internal_user_id`):** A cryptographically secure, random, and opaque identifier generated within the enclave to represent a Signal user, ensuring their Signal ID is not exposed to the host.
*   **Signal ID:** The user's phone number or public Signal identifier.
*   **LLM (Large Language Model):** External AI models used to process natural language and generate responses. Interactions with LLMs are mediated and secured by the enclave.

### 2.2 Document Scope
This document provides a comprehensive overview of the **system-wide privacy architecture** of the Signal Assistant, where the Enclave is presented as a central and critical privacy-enhancing mechanism. It covers:
*   The fundamental privacy principles guiding the system's design.
*   An inventory and classification of data types processed across all components.
*   Detailed descriptions of data flows, emphasizing how privacy is maintained at each stage and across trust boundaries (Host, Enclave, External LLM).
*   The role of various privacy-enhancing technologies and controls (e.g., TEEs, PII sanitization, encryption).
*   Policies regarding data storage, retention, and deletion.
*   Mechanisms for identity management and anonymization.
*   The system's capabilities and limitations regarding law enforcement requests.
*   Strategies for auditability, accountability, user transparency, and control.
*   Future considerations that will impact the privacy architecture.

This document builds upon and references the core system definition provided in the [Signal Assistant Core Specification](signal_assistant_core.md), focusing specifically on privacy-related aspects without duplicating core system functionalities already described there. It does *not* cover general Signal protocol privacy unless directly impacted or enhanced by the assistant's enclave architecture.

## 3. Privacy Principles

The Signal Assistant Enclave is founded on a robust set of privacy principles, deeply embedded in its design and operation. These principles guide every architectural decision and implementation choice.

*   **Privacy by Design:** Privacy considerations are integrated into every stage of the system's development lifecycle, not as an afterthought. This is exemplified by the fundamental decision to use Trusted Execution Environments (TEEs) to protect sensitive data.
*   **Data Minimization:** The system is designed to collect, process, and retain only the absolute minimum amount of personal data required to deliver its service. Transient data, such as plaintext user messages and LLM responses, are purged from memory immediately after use and are never persistently stored.
*   **User Control:** Users retain ultimate control over their data and interactions with the assistant. This includes the ability to delete their data and understand how their information is used.
*   **Transparency:** The architecture, including its privacy protections and limitations, is documented and made available to relevant stakeholders. Changes to fundamental privacy guarantees (e.g., through enclave updates) are designed to be verifiable through attestation.
*   **Confidentiality and Integrity:** The enclave ensures the confidentiality and integrity of sensitive data and code against attacks from a malicious host or external observers.
*   **Accountability:** The system is designed with mechanisms (e.g., privacy-preserving logging) that allow for internal accountability regarding data handling practices.

### 3.1 Architectural Philosophy
The overarching architectural philosophy is "enclave-centric," meaning that all sensitive data processing and business logic critical for privacy and security reside exclusively within the trusted boundaries of the TEE. The host environment is treated as untrusted and is minimized in its capabilities to interact with sensitive data. This isolation is further reinforced by rigorous key management, secure communication channels, and strict data flow controls.

## 4. Data Inventory & Classification

Understanding the types of data processed by the Signal Assistant is crucial for maintaining privacy. Data is systematically categorized by its nature and sensitivity, and its lifecycle is detailed below.

### 4.1 Data Inventory Table

The following table details the various data types processed by the Signal Assistant, their source, where they are processed, storage, retention, protection mechanisms, and exposure to third parties. References are made to component definitions in [Signal Assistant Core Specification, Section 4: System Components and Responsibilities](signal_assistant_core.md#4-system-components-and-responsibilities) and [Section 5: Identity and Session Model](signal_assistant_core.md#5-identity-and-session-model).

| Data Type | Source | Processing Location | Stored at Rest (Where) | Retention Policy | Protection Mechanisms | Exposed to Third Parties |
| :------------------------------ | :--------------------------------------------- | :------------------------------------------- | :------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------------------------------------------------- |
| **User Message (Plaintext)** | User (via Signal Protocol Decryption) | Enclave (Assistant Bot Logic) | NEVER | Ephemeral (purged immediately post-processing within Enclave memory) | TEE isolation, Enclave memory protection. | NO |
| **User Message (Signal-Encrypted Payload)** | User (via Signal Network) | Host (Signal Integration Layer), Enclave | NEVER | Ephemeral (transient during transport) | Signal Protocol E2EE, Host-Enclave Transport Encryption. | Signal Network (as E2EE payload) |
| **Signal Metadata (Sender ID, Timestamps, Device Info)** | Signal Network | Enclave (Signal Protocol Stack) | Enclave Secure Storage (on Host, encrypted by ESSK) | Indefinite (until user deletion, tied to `internal_user_id`) | TEE isolation, Encryption at rest (ESSK). | NO (Host only sees `internal_user_id` and non-identifying operational metadata) |
| **Signal Metadata (Non-Content)** | Signal transport / protocol | Host (routing / queues), Enclave (context building) | Host File System (queues, ephemeral cache), Host Logs (pseudonymized `internal_user_id` only) | Transient (queues), 30 days (pseudonymized host logs) | Encryption in transit (Host-Enclave), Pseudonymization (`internal_user_id`), Access controls. Note: Host-side queues/caches are NOT encrypted at rest, but they MUST NEVER contain plaintext message content, only `internal_user_id`s and non-identifying metadata. Future Change: Encryption at rest for host-side ephemeral storage MAY be considered. | Law Enforcement (under valid legal process) |
| **LLM Prompt (Plaintext)** | Enclave (Constructed from User Message & Context) | Enclave (LLM API Proxy/Client) | NEVER | Ephemeral (purged immediately post-LLM call within Enclave memory) | TEE isolation, Enclave memory protection, PII Sanitization ([Section 6.2](#62-pii-sanitization)). | NO (before sanitization) |
| **LLM Prompt (Sanitized)** | Enclave (PII Sanitizer) | Enclave (LLM API Proxy/Client) | NEVER | Ephemeral (purged immediately post-LLM call within Enclave memory) | TEE isolation, Enclave memory protection, PII Sanitization ([Section 6.2](#62-pii-sanitization)). | External LLM API (via encrypted channel) |
| **LLM Response (Plaintext)** | External LLM API | Enclave (LLM API Proxy/Client, Assistant Bot Logic) | NEVER | Ephemeral (purged immediately post-processing within Enclave memory) | TEE isolation, Enclave memory protection. | NO |
| **Long-Term Memory (Redacted Summaries/Embeddings)** | Enclave (Assistant Bot Logic) | Enclave (Assistant Bot Logic) | Enclave Secure Storage (on Host, encrypted by ESSK) | User-defined or system-defined TTL (purged on deletion) | TEE isolation, Encryption at rest (ESSK), Pseudonymization. | NO |
| **Signal User Identifier (UUID/Phone Number)** | Signal Network | Enclave (Identity Mapping Service) | Enclave Secure Storage (on Host, encrypted by ESSK) | Indefinite (until user deletion) | TEE isolation, Encryption at rest (ESSK), Access controls within Enclave. | NO (Host only sees `internal_user_id`) |
| **Internal User ID (`internal_user_id`)** | Enclave (Identity Mapping Service) | Enclave, Host (Operational Logging) | Enclave Secure Storage (on Host, encrypted by ESSK), Host File System (operational logs) | Indefinite (Enclave Secure Storage), 30 days (Host operational logs) | TEE isolation, Encryption at rest (ESSK), Pseudonymization. | NO (Directly); Host sees only opaque ID for operational logs. |
| **Conversational Context/State** | Enclave (Assistant Bot Logic) | Enclave | Enclave Secure Storage (on Host, encrypted by ESSK) / Ephemeral in Enclave memory | Ephemeral (short term in Enclave memory); Long-term (user-defined or system-defined TTL, purged on user deletion). | TEE isolation, Encryption at rest (ESSK). | NO |
| **System Configuration/Preferences** | User/Administrator | Enclave, Host | Enclave Secure Storage (on Host, encrypted by ESSK) / Host File System (non-sensitive) | Indefinite | TEE isolation, Encryption at rest (ESSK). | NO (unless public/non-sensitive config) |
| **Signal Protocol Keys (SPK)** | Enclave (KMS) | Enclave (Signal Protocol Stack) | Enclave Secure Storage (on Host, encrypted by ESSK) | Indefinite (until rotation/deletion) | TEE isolation, Encryption at rest (ESSK), KMS access controls. | NO |
| **Enclave Root Key (ERK)** | TEE Hardware | Enclave (KMS) | NEVER (Derived, in secure memory) | Ephemeral (derived on boot, exists only in TEE) | TEE hardware-backed security. | NO |
| **Enclave Secure Storage Keys (ESSK)** | Enclave (KMS) | Enclave (Secure Storage Interface) | Enclave Secure Storage (on Host, encrypted by ERK) | Indefinite (until rotation/deletion) | TEE isolation, Encryption at rest (ERK), KMS access controls. | NO |
| **LLM API Keys/Credentials** | Administrator (Provisioning) | Enclave (KMS) | Enclave Secure Storage (on Host, encrypted by ESSK) | Indefinite (until rotation/deletion) | TEE isolation, Encryption at rest (ESSK), KMS access controls. | External LLM API (via authenticated, encrypted channel). |
| **Host-Enclave Transport Key** | Enclave/Host (Key Exchange) | Enclave, Host (Signal Integration Layer) | NEVER | Ephemeral (rotated frequently) | Secure key exchange protocol, TEE isolation, Cryptography. | NO |
| **Attestation Artifacts (Reports, Measurements, Enclave Public Keys)** | Enclave / TEE platform | Host (verification), external auditors / clients (optional) | Host File System (verification/auditing), Publicly available (expected measurements) | Short-term (for immediate verification), Long-term (for auditing public measurements) | TEE isolation (for generation), Cryptographic signing, Public verifiability. Attestation reports and expected measurement lists MUST NOT include user- or tenant-specific data; they are strictly about code, configuration, and enclave identity. | YES (for transparency / auditing) |
| **Host Operational Logs** | Host, Enclave (Secure Logging Proxy) | Host File System | Host File System | 30 days | Anonymization (`internal_user_id` only), TTL. | NO (Internal use only) |
| **Enclave Internal Logs** | Enclave | Enclave (memory) | NEVER (unless anonymized, encrypted, and sent to Host Operational Logs) | Ephemeral (purged hourly or on shutdown) | TEE isolation. | NO |

**Note on "Exposed to Third Parties":** This column refers to routine operational exposure (e.g., external APIs, analytics providers, etc.). Law enforcement disclosures under valid legal process are governed separately by the specific provisions in [Section 9: Law Enforcement & Access Policies](#9-law-enforcement--access-policies).

### 4.2 Data Classification

Data handled by the system is classified based on its sensitivity, correlating with how it is protected:

*   **Sensitive PII (e.g., Signal User Identifiers, plaintext user messages, LLM prompts/responses):** This data MUST be processed exclusively within the Enclave and MUST NEVER be stored persistently in plaintext. When stored (e.g., Signal ID to `internal_user_id` mapping), it MUST be heavily encrypted by Enclave-controlled keys within secure storage.
*   **Sensitive Non-PII (e.g., Key Material):** Cryptographic keys MUST be handled with the highest security, managed by the Enclave KMS, and MUST NEVER leave the Enclave in plaintext.
*   **Pseudonymous Data (e.g., `internal_user_id`, anonymized interaction logs):** This data SHALL be designed not to directly identify an individual without access to the Enclave-controlled identity mapping. `internal_user_id`s MAY be exposed to the Host for operational purposes but MUST NOT be linkable to real-world identities by the Host.
*   **Non-Sensitive Operational Data (e.g., message sizes, timestamps):** General operational metrics that pose minimal privacy risk.

## 5. Data Flow & Processing

The data flow within the Signal Assistant Enclave architecture is meticulously designed to prioritize privacy and security at every stage. All sensitive data MUST either be processed directly within the Enclave or protected by encryption when traversing untrusted environments. This section details the step-by-step transitions, privacy controls, and identifier handling throughout the system.

### 5.1 High-Level Data Flow Diagram
*(Placeholder for a visual representation of the data flow, depicting interactions between User, Signal Servers, Host, Enclave, and External LLM APIs. Key encryption/decryption points, PII sanitization steps, and identifier transformations SHOULD be highlighted.)*

### 5.2 Detailed Data Flow Descriptions

#### 5.2.1 Inbound Message Flow (User to Enclave)
This flow details how a user's message reaches the Enclave for processing, aligning with [Signal Assistant Core Specification, Section 8.1: Inbound Message Flow](signal_assistant_core.md#81-inbound-message-flow).

1.  **User Sends Message:**
    *   **Description:** A user composes and sends a message to the Signal Assistant via their Signal client.
    *   **Privacy Controls:** Message MUST be end-to-end encrypted by the Signal protocol.
    *   **Identifiers:** User's Signal User Identifier (UUID/phone number) is present.
2.  **Signal Server Delivery to Host:**
    *   **Description:** The Signal server MUST deliver the Signal-encrypted message to the Host's Signal Integration Layer. The Host MUST terminate the TLS connection.
    *   **Privacy Controls:** Host MUST NOT decrypt the Signal-encrypted payload.
    *   **Identifiers:** User's Signal User Identifier (metadata, not within payload).
3.  **Host Re-encryption for Enclave:**
    *   **Description:** The Host's Signal Integration Layer MUST immediately re-encrypt the *entire* Signal-encrypted payload using a dynamically established, short-lived Host-Enclave Transport Key.
    *   **Privacy Controls:** Data MUST be encrypted; Host MUST have no access to plaintext.
    *   **Identifiers:** User's Signal User Identifier (metadata, not within payload).
4.  **Host to Enclave IPC:**
    *   **Description:** The Host MUST send this host-encrypted payload to the Enclave via a secure Inter-Process Communication (IPC) mechanism.
    *   **Privacy Controls:** Secure IPC MUST protect data in transit.
    *   **Identifiers:** User's Signal User Identifier (metadata, not within payload).
5.  **Enclave Ingress Decryption:**
    *   **Description:** The Enclave MUST receive the host-encrypted payload and decrypt it using the Host-Enclave Transport Key.
    *   **Privacy Controls:** Data MUST be decrypted within the trusted boundary of the Enclave.
    *   **Identifiers:** User's Signal User Identifier (metadata, not within payload).
6.  **Signal Message Decryption:**
    *   **Description:** The Enclave's Signal Protocol Stack MUST decrypt the actual user message using its securely managed Signal identity and session keys.
    *   **Privacy Controls:** Plaintext user message MUST become accessible *only within the Enclave's memory*. This is the first point where content is in plaintext.
    *   **Identifiers:** User's Signal User Identifier is present.
7.  **Identity Binding:**
    *   **Description:** The Enclave's Identity Mapping Service MUST use the Signal sender's ID to retrieve or create an opaque `internal_user_id` (see [Signal Assistant Core Specification, Section 5.1: Identity Mapping](signal_assistant_core.md#51-identity-mapping)). This mapping MUST happen *exclusively inside the Enclave*.
    *   **Privacy Controls:** Pseudonymization. Direct `Signal_ID` MUST be replaced with `internal_user_id` for subsequent internal processing.
    *   **Identifiers:** `internal_user_id` is now the primary identifier.
8.  **PII Sanitization:**
    *   **Description:** The plaintext user message MUST be passed through the Enclave's `PIISanitizer` (see [Section 6.2: PII Sanitization](#62-pii-sanitization)) to redact or replace any detected PII (e.g., phone numbers, email addresses).
    *   **Privacy Controls:** Data minimization, PII redaction.
    *   **Identifiers:** `internal_user_id` (associated with sanitized prompt).
9.  **LLM Processing:**
    *   **Description:** The (potentially sanitized) plaintext user message (prompt) MUST be fed to the Enclave's LLM API Proxy/Client within the enclave.
    *   **Privacy Controls:** Prompt MUST be PII-sanitized before LLM interaction.
    *   **Identifiers:** `internal_user_id` (associated with prompt).

#### 5.2.2 LLM Interaction Flow (Enclave to External LLM API)
This flow details how the Enclave securely interacts with external LLM APIs, aligning with [Signal Assistant Core Specification, Section 8.2: LLM Interaction Flow](signal_assistant_core.md#82-llm-interaction-flow).

1.  **Enclave Sends Prompt:**
    *   **Description:** The Enclave's LLM API Proxy/Client MUST make a secure, authenticated call to the external LLM API, sending the PII-sanitized prompt over an encrypted channel (e.g., TLS).
    *   **Privacy Controls:** PII Sanitization, encrypted transport (TLS), LLM API keys managed by Enclave KMS.
    *   **Identifiers:** NO PII; `internal_user_id` (not directly in prompt, but as a context for billing/usage with LLM if required and anonymized).
2.  **External LLM Processing:**
    *   **Description:** The external LLM MUST process the prompt and generate a response.
    *   **Privacy Controls:** Policies of the external LLM provider apply. The Enclave's upstream controls (PII Sanitization) MUST mitigate exposure.
    *   **Identifiers:** NO PII.
3.  **LLM Response to Enclave:**
    *   **Description:** The LLM API MUST return the response over the secure channel to the Enclave.
    *   **Privacy Controls:** Encrypted transport (TLS). LLM response MUST exist in plaintext *only within the Enclave's memory*.
    *   **Identifiers:** NO PII.

#### 5.2.3 Outbound Message Flow (Enclave to User)
This flow details how the Assistant's reply is sent back to the user, aligning with [Signal Assistant Core Specification, Section 8.3: Outbound Message Flow](signal_assistant_core.md#83-outbound-message-flow).

1.  **Enclave Response Generation & Encryption (Layer 1):**
    *   **Description:** The Enclave's Assistant Bot Logic MUST process the LLM response. The Enclave's Signal Protocol Stack MUST then encrypt the generated response using the appropriate Signal session keys for the recipient.
    *   **Privacy Controls:** Plaintext response MUST exist *only within the Enclave*. E2EE MUST be applied.
    *   **Identifiers:** Recipient's Signal User Identifier is used for encryption. `internal_user_id` is used for Enclave internal tracking.
2.  **Enclave Re-encryption for Host Transport:**
    *   **Description:** The Signal-encrypted response MUST be re-encrypted by the Enclave using the Host-Enclave Transport Key for secure transport back to the Host.
    *   **Privacy Controls:** Data MUST be encrypted; Host MUST have no access to plaintext.
    *   **Identifiers:** Recipient's Signal User Identifier (metadata, not within payload). `internal_user_id` (for Enclave internal tracking).
3.  **Enclave to Host IPC:**
    *   **Description:** The Enclave MUST send this host-encrypted payload to the Host via the secure IPC mechanism.
    *   **Privacy Controls:** Secure IPC MUST protect data in transit.
    *   **Identifiers:** Recipient's Signal User Identifier (metadata, not within payload).
4.  **Host Egress Decryption:**
    *   **Description:** The Host MUST receive the host-encrypted payload and decrypt it using the Host-Enclave Transport Key to retrieve the Signal-encrypted payload.
    *   **Privacy Controls:** Host MUST NOT access the plaintext message.
    *   **Identifiers:** Recipient's Signal User Identifier (metadata, not within payload).
5.  **Host Transmits Message:**
    *   **Description:** The Host MUST transmit the Signal-encrypted message to the Signal server for delivery to the user.
    *   **Privacy Controls:** Host handles encrypted payload only.
    *   **Identifiers:** Recipient's Signal User Identifier.
6.  **User Message Receipt:**
    *   **Description:** The Signal network MUST deliver the encrypted response to the user's Signal client, which then decrypts it for display.
    *   **Privacy Controls:** Signal Protocol E2EE.
    *   **Identifiers:** Recipient's Signal User Identifier.

#### 5.2.4 KMS Operations
*   **Description:** Key generation, retrieval, and deletion (e.g., for Signal keys, secure storage keys, LLM API keys) MUST occur exclusively within the Enclave's Key Management Service (KMS).
*   **Privacy Controls:** Keys MUST NEVER leave the Enclave in plaintext and MUST be encrypted by the Enclave Root Key when persisted on untrusted storage. Strict access controls MUST be enforced within KMS.
*   **Identifiers:** Key IDs, `internal_user_id` (for associating user-specific keys).

### 5.3 Data Processing Locations

*   **Host (Untrusted):**
    *   **Responsibilities (relevant to privacy):** Resource provisioning, Enclave lifecycle management, TLS termination for Signal communication, re-encryption of Signal messages for Enclave transport, relaying Enclave-encrypted responses to Signal servers.
    *   **Data Visibility:** MUST NEVER see plaintext user messages, LLM prompts/responses, or `Signal_ID`s linked to content. ONLY handles encrypted data-at-rest provided by the Enclave and non-sensitive operational logs.
*   **Enclave (Trusted):**
    *   **Responsibilities (relevant to privacy):** Decrypting Signal messages, PII sanitization, identity mapping, orchestrating LLM interactions, managing cryptographic keys, secure storage interfaces, secure logging, enforcing safety policies.
    *   **Data Visibility:** The SOLE location where sensitive data (plaintext user messages, LLM prompts/responses, `Signal_ID`s for identity binding, all cryptographic keys) is processed.
*   **External LLM APIs (Third-Party):**
    *   **Responsibilities (relevant to privacy):** Process PII-sanitized LLM prompts provided by the Enclave and return responses.
    *   **Data Visibility:** FULL for the sanitized prompt and response *during processing*. The Enclave's upstream PII sanitization and data minimization efforts MUST mitigate exposure. Their specific privacy policies are external to the Signal Assistant architecture.

## 6. Privacy Enhancing Technologies & Controls

The Signal Assistant Enclave employs a multi-layered approach to privacy protection, utilizing a combination of architectural isolation, cryptographic techniques, and explicit data handling policies.

### 6.1 Enclave's Role: Trusted Execution Environment (TEE)
The core privacy control is the use of a Trusted Execution Environment (TEE), specifically an enclave.
*   **Confidentiality and Integrity:** The enclave provides strong hardware-backed guarantees that the code and data loaded within it remain confidential and cannot be tampered with by an untrusted host operating system, hypervisor, or even physical attacks on memory. This ensures that sensitive operations (like Signal message decryption, PII sanitization, LLM prompt construction) occur in an isolated and protected environment.
*   **Attestation:** The enclave supports remote attestation, allowing users or auditors to cryptographically verify the exact code and configuration running inside a specific enclave. This provides verifiable assurance that the privacy guarantees outlined in this document are actively enforced. Any attempt to modify the enclave's behavior (e e.g., to exfiltrate plaintext data) would change its cryptographic measurement, invalidating attestation and making the alteration detectable.

### 6.2 PII Sanitization
*   **Mechanism:** The `PIISanitizer` (implemented in `src/signal_assistant/enclave/privacy_core/sanitizer.py`) is a critical component for data minimization and privacy, as defined in [Signal Assistant Core Specification, Section 4.3.1: Sub-components within Enclave - PII Sanitizer](signal_assistant_core.md#431-sub-components-within-enclave). It identifies and redacts common Personally Identifiable Information (PII) patterns from user messages.
*   **Targeted PII:** Current implementation focuses on common patterns for phone numbers and email addresses. This can be extended to other forms of PII as needed.
*   **Transformation/Redaction:** Detected PII is replaced with generic tokens (e.g., `[PHONE_NUMBER]`, `[EMAIL]`).
*   **Location of Sanitization:** Sanitization occurs *within the Enclave* after the user's message has been decrypted and *before* it is used for LLM interaction or any other processing that might involve untrusted external systems or logging. This ensures that PII is never exposed to external LLMs or logged, even in anonymized interaction logs.

### 6.3 Encryption Mechanisms
Multiple layers of encryption are employed to protect data at rest and in transit.
*   **End-to-End Encryption (Signal Protocol):** User messages are protected by Signal's robust end-to-end encryption from the user's client to the bot's Signal identity. This ensures privacy across the public internet. The enclave's Signal Protocol Stack manages the decryption and encryption of these messages *within the enclave*.
*   **Host-Enclave Transport Encryption:** Communication between the untrusted host and the enclave is secured using symmetric encryption. A `SecureChannel` (implemented in `src/signal_assistant/enclave/transport.py`) uses a shared symmetric key (`SHARED_SYMMETRIC_KEY`) to encrypt all messages transmitted over IPC. This key is established securely and rotated frequently. This ensures that even though the host manages the IPC, it cannot read the sensitive data being passed to/from the enclave.
*   **Storage Encryption (Enclave-Managed):** All persistent data written by the enclave to the host's untrusted disk (e.g., identity mappings, Signal key material) is encrypted by the enclave using an enclave-generated Secure Storage Key. This key itself is sealed (encrypted) by the Enclave Root Key, ensuring that data at rest on the host is unintelligible without access to the enclave's secure environment.

### 6.4 Data Minimization
Beyond PII sanitization, data minimization is enforced architecturally:
*   **Ephemeral Plaintext:** Plaintext user messages and LLM responses are treated as ephemeral. They are held in enclave memory only for the duration of active processing and immediately purged thereafter. They are *never* written to persistent storage in plaintext.
*   **Strict Logging Policy:** Operational logs on the host contain only non-sensitive, anonymized metadata (`internal_user_id`, timestamps, message sizes) and *never* include plaintext content or direct Signal IDs. Enclave internal logs are similarly ephemeral.
*   **Focused Storage:** Persistent storage on the host is limited to strictly necessary information, such as encrypted identity mappings and key material, all of which are encrypted by the enclave.

## 7. Data Storage & Retention

The Signal Assistant's data storage and retention policies are designed to uphold privacy principles, particularly data minimization and ephemerality of sensitive information. All persistent storage occurs on the untrusted host but is managed and encrypted by the secure enclave.

### 7.1 Storage Locations
*   **Host Database/File System (Enclave-Encrypted):** This is the primary location for any persistent data. This includes:
    *   **Identity Mappings (`Signal_ID` to `internal_user_id`):** Stored encrypted using the Secure Storage Key, generated and managed by the enclave. This mapping is critical for maintaining user continuity and respecting the privacy boundary between Signal IDs and internal processing.
    *   **Enclave Key Material:** Encrypted cryptographic keys (e.g., Signal identity keys, Secure Storage Key itself) are stored here, sealed by the Enclave Root Key.
*   **Host File System (Operational Logs):** Non-sensitive operational logs generated by the host. These logs contain only anonymized metadata (`internal_user_id`, timestamps, message sizes, etc.) and *never* contain plaintext content or direct Signal IDs.
*   **Enclave Internal Memory:** Plaintext user messages, LLM prompts/responses, and ephemeral session data exist *only* in the enclave's secure, volatile memory. They are purged immediately after processing.

### 7.2 Retention Policies
*   **Plaintext Conversation Content (User Messages, LLM Prompts/Responses):** **Never retained.** These are ephemeral and purged from enclave memory immediately after use. This ensures perfect forward secrecy for conversations.
*   **Signal-Encrypted Message Payloads:** **Never retained persistently.** Transiently held in enclave memory only for decryption/encryption.
*   **Long-Term Memory (Redacted Summaries/Embeddings):** Retained according to user-configurable or system-defined retention policies, and irrevocably purged upon user deletion. This data is pseudonymized and PII-sanitized, as described in [Signal Assistant Core Specification, Section 5.2.2](signal_assistant_core.md#522-conversational-context--long-term-memory).
*   **Identity Mappings (`Signal_ID` to `internal_user_id`):** Retained indefinitely *within the enclave's secure storage* unless a user explicitly requests deletion. This allows for persistent user experiences.
*   **Enclave Key Material:** Retained as long as required for operational functionality, securely encrypted. Rotation policies apply.
*   **Host Operational Logs:** Retained for a maximum of 30 days. These logs are primarily for debugging and auditing operational aspects and contain only anonymized, non-sensitive data.

### 7.3 Deletion Policies
*   **User-Initiated Deletion:** If a user requests deletion of their data (e.g., via a specific Signal command to the bot or through an external mechanism), the enclave will irrevocably purge their `Signal_ID` to `internal_user_id` mapping and any associated encrypted state from its secure storage. This effectively renders the user unknown to the bot.
*   **Automated Log Purge:** Host operational logs older than 30 days are automatically and irrevocably deleted.

## 8. Identity Management & Anonymization

The management of user identities is a cornerstone of the Signal Assistant's privacy architecture, focusing on pseudonymity and strict isolation of real-world identifiers.

### 8.1 Identity Binding
*   **Principle:** Signal IDs are never directly linked to internal user activity or stored in plaintext outside the enclave.
*   **Internal ID Generation:** When a new Signal ID interacts with the bot for the first time, the enclave generates a cryptographically secure, random, and opaque `internal_user_id`. This `internal_user_id` serves as the primary identifier for all subsequent processing within the enclave.
*   **Mapping Storage:** The crucial mapping of `(Signal_ID, internal_user_id)` is stored *exclusively within the enclave's secure storage*, encrypted using an enclave-specific key. This storage is attested and cryptographically bound to the specific enclave instance.
*   **Host Visibility:** The untrusted host environment *only* ever sees the `internal_user_id` when it needs to interact with the enclave regarding a specific user (e.g., to request an LLM inference for that user). The host *never* sees the associated `Signal_ID`. This prevents the host from correlating `internal_user_id` activity with a real-world Signal identity.

### 8.2 Internal Identifiers
*   Within the enclave, the `internal_user_id` is used to manage conversational state, preferences, and link to any securely stored (encrypted) user-specific data. This maintains a logical separation from the user's real-world identity.

### 8.3 Anonymization Strategies
*   **Pseudonymization:** The use of `internal_user_id` is a primary pseudonymization strategy, replacing direct identifiers with a unique, enclave-generated surrogate.
*   **PII Sanitization:** As detailed in Section 6, PII (like phone numbers and email addresses) is removed from user prompts *before* LLM interaction or logging, further anonymizing the data processed.
*   **Aggregated/Anonymized Metrics:** Any metrics or analytics gathered are processed within the enclave to ensure they are fully anonymized and aggregated before being exposed to the untrusted host or external systems. Direct correlations to `internal_user_id` or `Signal_ID` are prevented.
*   **Enclave Destruction Impact:** If an enclave is destroyed or re-provisioned without its secure storage, all identity mappings are irrevocably lost. This means users would appear as new to the bot, requiring re-binding. This is an explicit privacy-preserving design choice, demonstrating the ephemeral nature of identity associations if the secure boundary is compromised or reset.

## 9. Law Enforcement & Access Policies

This section explicitly defines the Signal Assistant Enclave's capabilities and limitations regarding data access by law enforcement. Our policy MUST be to comply with valid legal orders while upholding the strong privacy guarantees of the system. This policy is grounded in the attestable and transparent architecture described herein and in the [Signal Assistant Core Specification](signal_assistant_core.md).

**Scope of Constraints:** These constraints and policies apply exclusively to the server-side Signal Assistant Enclave system, which includes the Host components and the Enclave itself. They DO NOT apply to user devices, user-managed Signal clients, or Signal's own core messaging infrastructure (which operates under its separate and existing privacy policies).

### 9.1 Retrospective Data Access

The fundamental design principle of the enclave architecture MUST prevent retrospective access to sensitive user data. This is directly enabled by the key management and attestation model described in [Signal Assistant Core Specification, Section 9: Key Management and Attestation Model](signal_assistant_core.md#9-key-management-and-attestation-model).

#### 9.1.1 What the System CANNOT Provide (Retrospective)
*   **Requirement 9.1.1.1 (Plaintext User Messages):** The system MUST NEVER store plaintext conversation content persistently (prompts/responses). Once processed, this content MUST be purged from Enclave memory.
    *   **Technical Impossibility:** The system's design ensures plaintext messages (see Data Inventory row: **User Message (Plaintext)**) exist only ephemerally within the Enclave's volatile memory during active processing ([Signal Assistant Core Specification, Invariant 10.5](signal_assistant_core.md#10-system-level-invariants)). There are no data structures or storage locations on the Host or within the Enclave's persistent storage that hold historical plaintext message content. The keys required for Signal protocol decryption (Signal Protocol Keys - SPK) are managed exclusively within the Enclave, sealed by Enclave Secure Storage Keys (ESSK), which are themselves sealed by the Enclave Root Key (ERK), ensuring no Host access ([Signal Assistant Core Specification, Section 9.1.3, 9.1.2, 9.1.1](signal_assistant_core.md#91-key-types-and-purpose)). Therefore, the system MUST NOT and technically CANNOT provide historical plaintext messages under any circumstances.
*   **Requirement 9.1.1.2 (Signal IDs Linked to Conversation Content or Long-Term Memory):** Due to the identity binding strategy ([Section 8.1: Identity Binding](#81-identity-binding)), Signal User Identifiers MUST NEVER be directly linked to any stored conversation metadata or `Long-Term Memory`.
    *   **Technical Impossibility:** The Host only ever sees `internal_user_id`s in operational logs or when communicating with the Enclave. The Enclave stores the `Signal_ID` to `internal_user_id` mapping encrypted and isolated using an ESSK (see Data Inventory row: **Signal User Identifier (UUID/Phone Number)**). Historical Host Operational Logs ([Section 10.1: Logging Strategy](#101-logging-strategy) and Data Inventory row: **Host Operational Logs**) explicitly forbid Signal IDs and plaintext content. The `Long-Term Memory` (see Data Inventory row) is also pseudonymized and never linked to Signal IDs. Therefore, the system MUST NOT and technically CANNOT provide Signal User Identifiers linked to conversation content or `Long-Term Memory`.
*   **Requirement 9.1.1.3 (Encrypted LLM Prompts/Responses):** Encrypted LLM prompts or responses MUST be transiently handled within the Enclave and MUST NEVER be stored persistently, even in encrypted form.
    *   **Technical Impossibility:** Similar to plaintext user messages, LLM prompts and responses (see Data Inventory rows: **LLM Prompt (Plaintext)**, **LLM Prompt (Sanitized)**, **LLM Response (Plaintext)**) are treated as ephemeral within the Enclave and are immediately purged from memory after processing. There are no persistent data structures for these items. Therefore, the system MUST NOT and technically CANNOT provide encrypted LLM prompts or responses.
*   **Requirement 9.1.1.4 (Enclave Root Key (ERK) or Enclave Secure Storage Keys (ESSK) in Plaintext):**
    *   **Technical Impossibility:** As detailed in [Signal Assistant Core Specification, Section 9.1: Key Types and Purpose](signal_assistant_core.md#91-key-types-and-purpose), the ERK never leaves secure TEE memory, and ESSKs are only accessible in plaintext within an attested Enclave. Both are stored sealed by the ERK when at rest (see Data Inventory rows: **Enclave Root Key (ERK)**, **Enclave Secure Storage Keys (ESSK)**). This key management model (ERK sealing ESSK, ESSK encrypting data) technically prevents their plaintext extraction by any entity outside the attested Enclave. Therefore, the system MUST NOT and technically CANNOT provide these keys in plaintext.

#### 9.1.2 What the System CAN Provide (Retrospective)
*   **Requirement 9.1.2.1 (Limited Host Operational Logs):** The system MAY provide non-sensitive operational metadata (timestamps, `internal_user_id`, message sizes, error codes) from Host operational logs (see Data Inventory row: **Host Operational Logs**) for up to 30 days. This data MUST NOT contain conversation content or direct Signal User Identifiers ([Section 10.1: Logging Strategy](#101-logging-strategy) and [Signal Assistant Core Specification, Section 11.5](signal_assistant_core.md#115-logging-schema-constraints)). Under legal process, these pseudonymized logs may be handed over, strictly limited to the fields defined in the Logging Schema Constraints.
*   **Requirement 9.1.2.2 (Proof of Communication):** The system CAN confirm that communication occurred between the bot and a specific `internal_user_id` at a certain time, but MUST NOT reveal the content or purpose of the communication.
*   **Requirement 9.1.2.3 (Identity Mappings from Running Enclave):** If a valid legal order specifically targets the mapping for a known `internal_user_id` or `Signal_ID`, and the Enclave is currently running and accessible, the system CAN retrieve this mapping *from within the running Enclave* via a specific, authenticated Enclave API call. This mapping is stored encrypted by an ESSK (see Data Inventory row: **Signal User Identifier (UUID/Phone Number)**) and the Enclave will decrypt it for the sole purpose of responding to a valid legal order. If the Enclave is not running, or if its secure storage has been purged (due to an ERK compromise, for example, as per [Signal Assistant Core Specification, Section 9.3.2: Compromise Handling and Blast Radius](signal_assistant_core.md#93-rotation-and-compromise-handling)), this mapping MUST NOT be recoverable by a subsequent *attested* Enclave instance.
*   **Requirement 9.1.2.4 (Signal Metadata - Non-Content):** The system MAY provide certain non-content Signal metadata (see Data Inventory row: **Signal Metadata (Non-Content)**) collected and pseudonymized by the Host, such as connection times or general traffic patterns, under valid legal process. This metadata MUST NOT include message content, Signal IDs, or any information that can be linked to a specific user's conversation.

### 9.2 Prospective Wiretapping (Live Content Access)

Enabling real-time plaintext access to conversations (prospective wiretapping) MUST require fundamental changes to the Enclave code and its attestation. The technical impossibility of covert wiretapping is a core privacy guarantee.

*   **Requirement 9.2.1 (Requirement for Change):** A new version of the Enclave software MUST be developed and deployed, explicitly designed to enable such capabilities (e.g., storing plaintext messages persistently, exfiltrating them to the Host).
*   **Requirement 9.2.2 (Attestation Invalidation):** This new Enclave build MUST have a completely different cryptographic measurement (attestation hash).
    *   **Technical Impossibility:** The entire point of attestation ([Signal Assistant Core Specification, Section 9.4: Attestation Model](signal_assistant_core.md#94-attestation-model) and Data Inventory row: **Attestation Artifacts**) is to cryptographically verify the exact code and configuration running in the Enclave. Any modification to allow wiretapping would change the Enclave's cryptographic hash (e.g., MRENCLAVE), making it impossible to produce a valid attestation for the expected, privacy-preserving code. The attestation model *gates key access* (e.g., Signal Protocol Keys (SPK), Enclave Secure Storage Keys (ESSK), Enclave Root Key (ERK) â€“ see [Signal Assistant Core Specification, Section 9.4.3](signal_assistant_core.md#943-attestation-gating-key-access)), meaning keys necessary for decryption would not be released to an un-attested Enclave. Without these keys, the Enclave cannot decrypt Signal messages or unseal its state.
*   **Requirement 9.2.3 (Transparency and User Consent):** It MUST NOT be possible to covertly alter the Enclave's behavior to enable wiretapping without invalidating the attestation and making the change publicly detectable. We MUST commit to never deploying an Enclave with wiretapping capabilities without explicit, public changes to the software, new attestations, and full transparency to our users.

### 9.3 Public Detectability of Attestation

To ensure transparency and allow for public verification of the privacy guarantees, the attestation mechanism is designed to be publicly detectable.

*   **Mechanism:** Signal or a trusted third party WILL publish the expected cryptographic measurements (e.g., MRENCLAVE, MRSIGNER) of all officially released, privacy-preserving Enclave builds. This information forms part of the **Attestation Artifacts** (see Data Inventory table).
*   **Client/Operator Verification:** End-user Signal clients or independent operators MAY be able to retrieve the remote attestation report from a running Signal Assistant Enclave instance and cryptographically verify its measurement against the published, expected values.
*   **Detection of Deviation:** Any deviation between the attested measurement and the published expected value would indicate that a non-standard, potentially compromised, or privacy-violating Enclave build is in operation. This deviation would invalidate trust in that Enclave instance and should trigger alerts or refusal of service by clients.

### 9.4 Legal & Regulatory Context

*   **Requirement 9.4.1:** The Signal Assistant MUST operate with an awareness of global privacy regulations (e.g., GDPR, CCPA).
*   **Requirement 9.4.2:** The architecture SHALL provide a technical foundation for compliance, allowing for specific policy implementations (e.g., user deletion requests) to meet regulatory requirements.
*   **Requirement 9.4.3:** The `CHECK_LE_POLICY` command within the Enclave's Assistant Bot Logic (see `src/signal_assistant/enclave/app.py` in the implementation) MUST enforce policies for accessing data, such that sensitive requests are denied.

## 10. Auditability & Accountability

Maintaining a verifiable record of system operations, especially concerning data handling, is crucial for accountability and trust.

### 10.1 Logging Strategy

*   **Requirement 10.1.1 (Purpose):** Logs MUST be designed primarily for operational monitoring, debugging, and security auditing, NOT for retrospective access to sensitive user data.
*   **Requirement 10.1.2 (What is Logged - Host Operational Logs):** Host operational logs MUST strictly adhere to the "Logging Schema Constraints" defined in [Signal Assistant Core Specification, Section 11.5](signal_assistant_core.md#115-logging-schema-constraints). This ensures logs contain only allowed non-sensitive data, including:
    *   Timestamp of event (message receipt/send, error).
    *   `internal_user_id` (not Signal User Identifier).
    *   Message size (encrypted or sanitized message lengths).
    *   Processing duration within the Enclave.
    *   Error codes or operational warnings.
    *   Attestation verification logs.
*   **Requirement 10.1.3 (What is NOT Logged - Host Operational Logs):** Host operational logs MUST NEVER contain any explicitly forbidden fields as per [Signal Assistant Core Specification, Section 11.5](signal_assistant_core.md#115-logging-schema-constraints), including:
    *   Plaintext user message content or LLM responses.
    *   Signal User Identifiers.
    *   Any other PII.
*   **Requirement 10.1.4 (Log Retention):** Host operational logs MUST have a strict maximum 30-day retention period, after which they MUST be hard purged.
*   **Requirement 10.1.5 (Enclave Secure Logs):** Internal debugging logs within the Enclave MUST be ephemeral and in-memory. They MUST be purged frequently (e.g., hourly) or upon Enclave shutdown. They MUST NEVER be written to persistent storage unless anonymized, encrypted, and adhere to the Host operational log TTLs and the Logging Schema Constraints.

### 10.2 Audit Trails

The combination of remote attestation, secure logging policies, and the strict Host-Enclave separation MUST create a robust audit trail.

*   **Requirement 10.2.1 (Verifiable Enclave State):** Attestation records MUST provide cryptographic proof of the exact code running in the Enclave at any given time, confirming that the privacy-preserving logic was in place.
*   **Requirement 10.2.2 (Host Operational Records):** Host logs, while limited in content, MUST provide an auditable record of system events, indicating interactions with `internal_user_id`s, message volumes, and any anomalies, without exposing sensitive content.
*   **Requirement 10.2.3 (Internal Accountability):** Within the Enclave, the design MUST ensure that all sensitive operations are subject to internal controls and logging (even if ephemeral), preventing unauthorized data access or manipulation.

## 11. Threat Model (Privacy-Specific)

This privacy-specific threat model focuses on scenarios where user privacy could be compromised, particularly concerning sensitive data exposure, unauthorized access, and re-identification. It builds upon the general system threat model outlined in the [Signal Assistant Enclave Architecture design document](../../openspec/changes/signal-assistant-enclave-architecture/design.md#2-threat-model) and references controls defined in the [Signal Assistant Core Specification](signal_assistant_core.md) and this document.

### 11.1 Identified Privacy Threats and Attacker Classes

The following attacker classes and their potential privacy threats are considered:

*   **11.1.1 Malicious Host Operator:**
    *   **Description:** The cloud provider or a compromised host operator with full control over the physical server and the Host OS.
    *   **Threats:**
        *   Reading plaintext user messages or LLM prompts/responses from Host memory/disk.
        *   Linking Signal User Identifiers to `internal_user_id`s or activity logs.
        *   Tampering with data in transit between Host and Enclave.
        *   Exfiltrating encrypted persistent data from Host storage without Enclave's knowledge.
        *   Attempting to inspect Enclave memory for sensitive data.

*   **11.1.2 External Eavesdropper:**
    *   **Description:** An adversary monitoring network traffic between the Host and external LLM APIs, or between the user and Signal servers.
    *   **Threats:**
        *   Intercepting PII in LLM prompts/responses (if not sanitized).
        *   Inferring user activity or sensitive topics from LLM interactions.
        *   Intercepting Signal-encrypted messages before Host TLS termination.

*   **11.1.3 Insider Threat:**
    *   **Description:** A malicious employee or contractor with operational access to the Host.
    *   **Threats:**
        *   Accessing plaintext conversation data (via compromised Host processes).
        *   Abusing operational access to de-anonymize `internal_user_id`s by combining limited Host logs with other external information.

*   **11.1.4 Abusive Law Enforcement Request:**
    *   **Description:** A legal request that seeks access to data beyond what the architecture is designed to provide or retain.
    *   **Threats:**
        *   Compelling the system to provide historical plaintext conversations.
        *   Demanding Signal User Identifiers linked to conversation content.
        *   Demanding implementation of prospective wiretapping capabilities.

*   **11.1.5 Advanced Side-Channel Attacks:**
    *   **Description:** Sophisticated attacks attempting to infer sensitive Enclave state through indirect means (e.g., power consumption, timing, electromagnetic emanations).
    *   **Threats:**
        *   Leaking cryptographic keys or plaintext data from within the Enclave.

### 11.2 Mitigation Strategies

The architectural design and implemented controls directly address these privacy threats, mapping to requirements and features described in the [Signal Assistant Core Specification](signal_assistant_core.md) and this document.

*   **11.2.1 Enclave Isolation (Mitigates Malicious Host Operator, Insider Threat, Side-Channel):**
    *   **Control:** Sensitive data (plaintext messages, LLM prompts/responses, Signal keys, identity mappings) MUST NEVER leave the Enclave in plaintext ([Signal Assistant Core Specification, Invariant 10.1](signal_assistant_core.md#10-system-level-invariants)).
    *   **Mechanism:** TEE hardware guarantees, Enclave memory protection.
*   **11.2.2 Host-Enclave Transport Encryption (Mitigates Malicious Host Operator, External Eavesdropper):**
    *   **Control:** All communication between the Host and Enclave MUST be encrypted with a frequently rotated symmetric key ([Section 6.3: Encryption Mechanisms](#63-encryption-mechanisms)).
    *   **Mechanism:** `SecureChannel` (`src/signal_assistant/enclave/transport.py`), cryptographic primitives.
*   **11.2.3 PII Sanitization (Mitigates External Eavesdropper, Malicious LLM Provider):**
    *   **Control:** The `PIISanitizer` MUST remove PII from prompts *before* they are sent to external LLM APIs ([Section 6.2: PII Sanitization](#62-pii-sanitization), [Signal Assistant Core Specification, Requirement 7.1.3](signal_assistant_core.md#7-llm-orchestration-model)).
    *   **Mechanism:** Regular expression matching (`src/signal_assistant/enclave/privacy_core/sanitizer.py`).
*   **11.2.4 Identity Pseudonymization (Mitigates Malicious Host Operator, Insider Threat):**
    *   **Control:** The use of opaque `internal_user_id`s and the Enclave's exclusive control over `Signal_ID` to `internal_user_id` mapping MUST prevent Host operators and insiders from linking activity logs to real-world Signal User Identifiers ([Section 8: Identity Management & Anonymization](#8-identity-management--anonymization), [Signal Assistant Core Specification, Requirement 5.1.1.4](signal_assistant_core.md#5-identity-and-session-model)).
    *   **Mechanism:** Enclave-managed identity mapping service, encrypted storage for mapping.
*   **11.2.5 Secure Key Management (Mitigates Malicious Host Operator, Insider Threat, Side-Channel):**
    *   **Control:** All cryptographic keys MUST be generated, managed, and used exclusively within the Enclave (via the KMS) ([Section 5.2.4: KMS Operations](#524-kms-operations)). Keys MUST NEVER leave the Enclave in plaintext.
    *   **Mechanism:** Enclave KMS (`src/signal_assistant/enclave/kms.py`), Enclave Root Key, encryption at rest for persistent keys.
*   **11.2.6 No Persistent Plaintext Storage (Mitigates Malicious Host Operator, Insider Threat, Abusive LE Request):**
    *   **Control:** User messages and LLM responses MUST be ephemeral within the Enclave and MUST NOT be stored persistently in plaintext ([Section 7.2: Retention Policies](#72-retention-policies), [Signal Assistant Core Specification, Invariant 10.5](signal_assistant_core.md#10-system-level-invariants)).
    *   **Mechanism:** Immediate purging from Enclave memory.
*   **11.2.7 Remote Attestation (Mitigates Malicious Host Operator, Abusive LE Request):**
    *   **Control:** Attestation MUST provide verifiable proof that the expected, uncompromised, privacy-preserving code is running within the Enclave, deterring and detecting attempts at covert modification ([Section 6.1: Enclave's Role](#61-enclaves-role)).
    *   **Mechanism:** Hardware-backed attestation primitives, cryptographic measurement of Enclave state.
*   **11.2.8 Strict Logging Policies (Mitigates Malicious Host Operator, Insider Threat, Abusive LE Request):**
    *   **Control:** Anonymized and time-limited Host logs MUST prevent reconstruction of sensitive user activity ([Section 10.1: Logging Strategy](#101-logging-strategy), [Signal Assistant Core Specification, Invariant 10.4](signal_assistant_core.md#10-system-level-invariants)).
    *   **Mechanism:** Filtered logging in Enclave, `internal_user_id` only on Host, strict TTLs.
*   **11.2.9 Legal & Regulatory Alignment (Mitigates Abusive LE Request):**
    *   **Control:** The system MUST clearly define its capabilities and limitations regarding law enforcement requests, based on its technical architecture ([Section 9: Law Enforcement & Access Policies](#9-law-enforcement--access-policies)).
    *   **Mechanism:** Publicly documented policies, `CHECK_LE_POLICY` command in Enclave.

## 12. User Transparency & Control

Empowering users with understanding and control over their privacy is a key objective of the Signal Assistant.

### 12.1 User Consent
*   **Explicit Opt-in:** Users will be required to explicitly opt-in to use the Signal Assistant, acknowledging the unique privacy guarantees and limitations of its enclave-based architecture.
*   **Transparent Terms:** Clear and concise terms of service and a privacy policy will detail data handling practices, the role of the enclave, and the system's commitment to user privacy.

### 12.2 Information Provided to Users
*   **Architectural Overview:** Users will be provided with accessible explanations of how the enclave architecture works to protect their privacy, including the separation of duties between the host and the enclave.
*   **Data Handling Details:** Clear information will be given regarding what data is processed, where it resides (e.g., "within the secure enclave," "encrypted on host disk"), how long it is retained, and who can access it (i.e., only the enclave itself).
*   **Attestation:** Users will be informed about the availability of remote attestation and how it enables them to verify the integrity and expected behavior of the bot's enclave.

### 12.3 Mechanisms for User Data Access/Deletion
*   **Data Deletion Requests:** Users will have a clear mechanism to request the deletion of their associated data. Upon such a request, the enclave will irrevocably purge the `Signal_ID` to `internal_user_id` mapping and any associated encrypted state, effectively making the user's past interactions unrecoverable.
*   **No Direct Data Access:** Due to the ephemeral nature of plaintext conversation content and the pseudonymization of identities, users will not have direct "access" to their past plaintext conversations, as these are never stored. Instead, the focus is on the right to be forgotten.
*   **Control over LLM Interaction:** Users will be informed about the anonymization and sanitization processes applied to their prompts before interacting with external LLMs.
*   **Opt-out/Discontinuation:** Users will have simple and clear ways to opt-out of the service or discontinue their use, triggering associated data deletion processes.

## 13. Future Considerations

The privacy architecture of the Signal Assistant Enclave is a continuously evolving domain. As technology advances and user needs change, several key areas are identified for future consideration and development to further enhance privacy and security.

*   **13.1 Real Signal Protocol Integration:** The current architecture uses a simplified Signal protocol stack within the enclave. Future work will involve integrating a fully-fledged, battle-tested Signal protocol library (e.g., Signal Protocol library for Python) directly into the enclave. This will ensure full compatibility with the latest Signal features and cryptographic best practices, further hardening the message handling process.
*   **13.2 Hardware TEE Integration (Beyond Initial Emulation):** While the current design is TEE-agnostic and can run on various TEEs (including potentially simulated environments for development), future efforts will focus on deep optimization and integration with specific hardware-backed TEEs (e.g., Intel SGX, AMD SEV-SNP) to leverage their unique security features and performance enhancements. This could include specialized attestation mechanisms and direct hardware-backed key derivation.
*   **13.3 Enhanced PII Sanitization and Redaction:** Expanding the capabilities of the `PIISanitizer` to detect and redact a broader range of PII types (e.g., financial information, national identifiers) through more advanced NLP techniques or rule-based systems. This could also involve context-aware redaction to minimize false positives.
*   **13.4 Federated Learning/Private AI Techniques:** Exploring the integration of techniques like Federated Learning or other privacy-preserving machine learning methods. This would enable model training or refinement using aggregated, anonymized user data without individual data ever leaving user devices or the secure enclave, further enhancing data minimization for model development.
*   **13.5 User-Configurable Privacy Settings:** Implementing more granular user controls over specific privacy aspects, such as the level of anonymization, retention periods for certain types of (non-sensitive) metadata, or explicit consent for new data processing activities.
*   **13.6 Formal Verification:** Applying formal verification methods to critical components of the enclave code, particularly the Signal protocol stack and key management, to mathematically prove their correctness and adherence to privacy specifications.
*   **13.7 Advanced Threat Modeling and Red Teaming:** Continuous and iterative threat modeling, including engaging with independent security researchers and conducting red team exercises, to identify and mitigate novel privacy attack vectors against the enclave and its surrounding infrastructure.
*   **13.8 Dynamic Data Policy Enforcement:** Developing mechanisms for dynamic, policy-based data access control within the enclave, allowing for fine-grained management of data visibility and processing based on real-time contexts and user preferences.
