## ADDED Requirements

### Requirement: Enclave SHALL Provide Key Management Service (KMS)
All cryptographic keys within the system shall be managed by an Enclave Key Management Service (KMS) operating exclusively inside the enclave.
#### Scenario: Key Generation Request
Given a component within the enclave requires a new cryptographic key,
When it requests this key from the KMS,
Then the KMS shall generate and provide the key, ensuring its lifecycle is managed securely within the enclave.

### Requirement: Enclave Root Key SHALL Be Derived and Used for Key Encryption
An Enclave Root Key shall be derived from the TEE's unique hardware-backed key (e.g., Intel SGX Seal Key, AMD SEV-SNP Guest Owner Key), shall never leave the enclave, and shall be used to encrypt all other enclave-generated keys at rest.
#### Scenario: Enclave Bootstrapping
Given the enclave is initializing,
When the KMS starts up,
Then it shall derive the Enclave Root Key from the TEE's hardware-backed key,
And this key shall remain exclusively within the enclave's secure boundary,
And it shall be used to decrypt other stored keys for operational use.

### Requirement: Signal Keys SHALL Be Managed Exclusively in Enclave
Signal identity keys, pre-keys, and session keys shall be generated, managed, and stored (encrypted using the Enclave Root Key) exclusively within the enclave's persistent secure storage.
#### Scenario: Signal Registration
Given the bot needs to register a new Signal identity,
When the registration process occurs,
Then the identity keys shall be generated within the enclave,
And securely stored in the enclave's persistent storage, encrypted by the Enclave Root Key.
#### Scenario: Signal Session Establishment
Given a new Signal session is being established with a user,
When session keys are generated,
Then these keys shall be managed by the Signal protocol stack within the enclave, providing forward secrecy.

### Requirement: Host-Enclave Transport Key SHALL Be Used for Secure IPC
A short-lived, ephemeral symmetric Host-Enclave Transport Key shall be established via a secure authenticated channel (e.g., TLS with mutual attestation or a bespoke attestation-bound key exchange) between the host proxy and the enclave, and rotated frequently.
#### Scenario: Secure Channel Establishment
Given the host and enclave need to communicate securely,
When the enclave launches and attests successfully,
Then a Host-Enclave Transport Key shall be established for secure IPC,
And this key shall be rotated frequently (e.g., per session or per hour) to limit exposure.

### Requirement: Secure Storage Key SHALL Be Used for Host Persistent Data
A symmetric Secure Storage Key shall be generated by the enclave and used to encrypt all persistent data stored on the host's disk (e.g., identity mappings). This key shall be encrypted by the Enclave Root Key when at rest.
#### Scenario: Encrypting Identity Mappings for Storage
Given the enclave needs to store a new identity mapping persistently on the host,
When the mapping is prepared for storage,
Then it shall be encrypted using the Secure Storage Key,
And the Secure Storage Key itself shall be encrypted by the Enclave Root Key when not in use.



### Requirement: Key Rotation SHALL Be Implemented for All Key Types
All keys shall adhere to defined rotation policies: Signal Session Keys (automatically by protocol), Host-Enclave Transport Key (frequently), Secure Storage Key (periodically), and Identity Keys (periodically or upon compromise).
#### Scenario: Secure Storage Key Rotation
Given the policy mandates monthly rotation for the Secure Storage Key,
When the rotation schedule is met,
Then the enclave shall generate a new Secure Storage Key,
Re-encrypt all data protected by the old key with the new key,
And securely dispose of the old key.
