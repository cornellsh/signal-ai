# Logging and Observability Enforcement Specification

This document details the requirements for enforcing strict logging and observability policies within the Signal Assistant system, ensuring compliance with privacy invariants across both the untrusted Host and trusted Enclave environments. It aligns with the `Signal Assistant Core Specification` (core) and `Signal Assistant Enclave Privacy Architecture Document` (privacy).

## ADDED Requirements

### Centralized Logging Interfaces

### Requirement: Host-Side Secure Logging Interface

*   **Description:** The Host MUST implement a dedicated logging interface (e.g., `src/signal_assistant/host/logging_client.py`) that strictly adheres to the "Allowed Log Fields" defined in `core` 11.5. This interface MUST reject attempts to log explicitly forbidden fields (e.g., plaintext user content, LLM prompts/responses, direct `SignalID`s, or PII patterns). All Host components MUST use this interface for operational logging.
*   **core Ref:** 4.1, 4.2, 4.6, 10.4, 11.5
*   **privacy Ref:** 4.1, 5.3, 10.1

#### Scenario:
    *   `GIVEN` a Host component attempts to log a message directly containing a user's phone number.
    *   `WHEN` the logging interface is invoked.
    *   `THEN` the logging interface MUST either reject the log entry (e.g., raise an error) or sanitize the content before logging.
    *   `GIVEN` a Host component attempts to log an `internal_user_id` and an operation type.
    *   `WHEN` the logging interface is invoked.
    *   `THEN` the log entry MUST be accepted and formatted according to `core` 11.5.

### Requirement: Enclave-Side Secure Logging Interface

*   **Description:** The Enclave MUST implement a dedicated logging interface (e.g., `src/signal_assistant/enclave/secure_logging.py`) that strictly enforces the "Allowed Log Fields" from `core` 11.5. This interface MUST reject logging of forbidden content. Logs generated by this interface (if persisted) MUST be anonymized and encrypted before transmission to the Host. All Enclave components MUST use this interface for operational logging.
*   **core Ref:** 4.3, 4.6, 10.4, 11.5
*   **privacy Ref:** 4.1, 5.3, 10.1

#### Scenario:
    *   `GIVEN` an Enclave component attempts to log the full plaintext content of a user message.
    *   `WHEN` the `secure_logging` interface is invoked.
    *   `THEN` the log entry MUST be rejected or cause an error.
    *   `GIVEN` an Enclave component logs an `internal_user_id` and an event timestamp.
    *   `WHEN` the `secure_logging` interface is invoked.
    *   `THEN` the log entry is processed, potentially anonymized/encrypted, and formatted for onward transmission.

### Static Analysis for Logging Violations

### Requirement: CI-Integrated Static Log Analysis

*   **Description:** The CI/CD pipeline MUST include static analysis tooling (e.g., custom `ruff` checks, `pylint` rules, or `ripgrep` patterns) to automatically detect and flag logging calls that violate `core` 11.5.
*   **core Ref:** 10.4, 11.5
*   **privacy Ref:** 10.1

#### Scenario:
    *   `GIVEN` a developer adds a line of code to `src/signal_assistant/host/some_module.py` like `logger.info(f"User message: {user_message_text}")`.
    *   `WHEN` this code is pushed to a branch and the CI pipeline runs.
    *   `THEN` the static analysis MUST flag this line as a violation of `core` 11.5, preventing the build from passing.
    *   `GIVEN` a developer attempts to use `logging.info()` directly in a core Host or Enclave module instead of the approved secure logging interface.
    *   `WHEN` the static analysis runs.
    *   `THEN` the static analysis MUST flag this as a policy violation.

### Requirement: Prohibition of Sensitive Derivative Logging

*   **Description:** Static analysis MUST also prohibit the logging of hashed, encrypted, or otherwise encoded representations of plaintext user content or `SignalID`s that could act as stable, pseudo-anonymous identifiers beyond the allowed `internal_user_id`.
*   **core Ref:** 11.5 (Forbidden Log Fields)
*   **privacy Ref:** 4.1 (Data Inventory - Host Operational Logs)

#### Scenario:
    *   `GIVEN` a developer attempts to log `logger.info(f"Message hash: {hash_function(message_body)}")` or `logger.info(f"SignalID_fingerprint: {sha256(Signal_ID)}")`.
    *   `WHEN` the static analysis runs.
    *   `THEN` it MUST flag these patterns as violations, as they undermine the `internal_user_id` pseudonymity invariant.

### Runtime Assertions and Integration Tests

### Requirement: Host Logging Blindness Integration Test

*   **Description:** An integration test MUST be implemented (`tests/test_logging_blindness.py`) to verify that the Host's operational logs contain no plaintext sensitive data (PII, LLM content, `SignalID`s) after a full message processing flow.
*   **core Ref:** 10.2, 10.4, 11.5
*   **privacy Ref:** 5.3, 10.1

#### Scenario:
    *   `GIVEN` a test simulates a user sending a message containing PII to the Assistant.
    *   `WHEN` the message is processed by the Enclave, and mock LLM interactions occur.
    *   `AND` the Host generates its operational logs.
    *   `THEN` an automated check of the Host's log output MUST confirm the absence of any plaintext PII, raw `SignalID`s, or any pseudo-anonymous derivatives in violation of `core` 11.5.

## MODIFIED Requirements

*(No explicit modifications to existing requirements are defined in this spec delta, as these are primarily ADDED functionalities for enforcement. Existing `core` and `privacy` requirements are referenced as foundational principles.)*

## REMOVED Requirements

*(None)*